version: "0.5"

environment:
  - GOWORK=off

processes:
  wazero:
    command: task run:wazero
    availability:
      restart: "always"

  demo:
    command: task run:demo
    availability:
      restart: "always"

  wrangler:
    command: task run:wrangler
    disabled: true
    availability:
      restart: "always"

  watcher-wazero:
    command: |
      watchexec \
        --watch demo \
        --watch handler \
        --watch runtime \
        --watch cmd/wazero \
        --exts go,html \
        --ignore '*.swp' \
        --ignore '*.swo' \
        --ignore '.git' \
        --debounce 500ms \
        --clear \
        --on-busy-update restart \
        -- sh -c 'echo "ðŸ”„ Rebuilding wazero..." && task build:host && echo "âœ… Rebuild complete, restarting..." && lsof -ti :8080 | xargs kill -9 2>/dev/null || true'
    depends_on:
      wazero:
        condition: process_started
    availability:
      restart: on_failure
      backoff_seconds: 5
