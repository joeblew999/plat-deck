version: '3'

tasks:
  setup:
    desc: Create Cloudflare resources
    cmds:
      - bunx wrangler r2 bucket create {{.CF_R2_INPUT}} 2>/dev/null || echo "{{.CF_R2_INPUT}} exists"
      - bunx wrangler r2 bucket create {{.CF_R2_OUTPUT}} 2>/dev/null || echo "{{.CF_R2_OUTPUT}} exists"
      - bunx wrangler r2 bucket create {{.CF_R2_WASM}} 2>/dev/null || echo "{{.CF_R2_WASM}} exists"
      - bunx wrangler queues create {{.CF_QUEUE}} 2>/dev/null || echo "{{.CF_QUEUE}} exists"
      - bunx wrangler kv namespace create {{.CF_KV_NAMESPACE}} 2>/dev/null || echo "{{.CF_KV_NAMESPACE}} exists"
      - echo "Run 'task cf:list' to get KV namespace ID"

  list:
    desc: List Cloudflare resources
    cmds:
      - echo "=== R2 ===" && bunx wrangler r2 bucket list
      - echo "=== Queues ===" && bunx wrangler queues list
      - echo "=== KV ===" && bunx wrangler kv namespace list

  notifications:
    desc: Enable R2 event notifications
    cmds:
      - bunx wrangler r2 bucket notification create {{.CF_R2_INPUT}} --event-type object-create --queue {{.CF_QUEUE}} 2>/dev/null || echo "Already exists"

  deploy:
    desc: Deploy to Cloudflare Workers
    cmds:
      - task build:cloudflare
      - bunx wrangler deploy --config wrangler.toml

  teardown:
    desc: Delete all Cloudflare resources (DESTRUCTIVE)
    prompt: This will DELETE all Cloudflare resources. Are you sure?
    cmds:
      - bunx wrangler delete {{.CF_WORKER_NAME}} --force 2>/dev/null || true
      - bunx wrangler r2 bucket delete {{.CF_R2_INPUT}} 2>/dev/null || true
      - bunx wrangler r2 bucket delete {{.CF_R2_OUTPUT}} 2>/dev/null || true
      - bunx wrangler r2 bucket delete {{.CF_R2_WASM}} 2>/dev/null || true
      - bunx wrangler queues delete {{.CF_QUEUE}} 2>/dev/null || true
      - echo "âœ“ Teardown complete"

  # R2 operations
  r2-upload:
    desc: Upload a .dsh file (task cf:r2-upload FILE=deck.dsh)
    cmds:
      - bunx wrangler r2 object put {{.CF_R2_INPUT}}/{{.FILE | base}} --file={{.FILE}} --remote

  r2-list:
    desc: List R2 buckets
    cmds:
      - bunx wrangler r2 bucket list
