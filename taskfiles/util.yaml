version: '3'

tasks:
  deps:
    desc: Install dependencies
    cmds:
      - go mod download && go mod tidy
      - bun install
      - |
        # Check for watchexec (required for auto-rebuild)
        if ! command -v watchexec &> /dev/null; then
          echo "⚠️  watchexec not found (required for auto-rebuild on file changes)"
          echo "Install with:"
          echo "  macOS:   brew install watchexec"
          echo "  Linux:   apt install watchexec  (or: pacman -S watchexec)"
          echo "  Windows: scoop install watchexec  (or: choco install watchexec)"
          echo "  Cargo:   cargo install watchexec-cli"
          echo ""
          echo "Auto-rebuild will be disabled without watchexec."
          echo "You can still develop normally, just run 'task build:host' manually after changes."
        else
          echo "✅ watchexec found - auto-rebuild enabled"
        fi

  fmt:
    desc: Format code
    cmds: [go fmt ./...]

  lint:
    desc: Run linters
    cmds:
      - go vet ./...
      - which golangci-lint >/dev/null && golangci-lint run || true

  check:
    desc: Format, lint, test
    cmds:
      - task: fmt
      - task: lint
      - task test:unit

  clean:
    desc: Clean everything
    cmds:
      - rm -rf {{.BUILD_DIR}} {{.SOURCE_DIR}} .wrangler node_modules
      - go clean -cache

  install-hooks:
    desc: Install git hooks
    cmds:
      - cp .githooks/pre-commit .git/hooks/pre-commit
      - chmod +x .git/hooks/pre-commit
      - echo "✅ Pre-commit hook installed"

  setup:
    desc: Full setup
    cmds:
      - task: deps
      - task: install-hooks
      - task cf:setup
      - task build:all
      - 'echo "Done! Update wrangler.toml with KV ID, then: task cf:deploy"'
