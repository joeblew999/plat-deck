<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeckFS Demo</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .container { max-width: 1800px; margin: 0 auto; }
        h1 { color: #00d4ff; margin-bottom: 5px; }
        .subtitle { color: #888; margin-bottom: 12px; }
        .layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        @media (max-width: 1200px) { .layout { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
        .panel {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .panel-header h2 {
            margin: 0;
            color: #00d4ff;
            font-size: 1.1rem;
        }
        .toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .toolbar select {
            background: #0f0f23;
            color: #eee;
            border: 1px solid #333;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        textarea {
            width: 100%;
            height: 350px;
            background: #0f0f23;
            color: #00ff88;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            resize: vertical;
        }
        textarea:focus { outline: none; border-color: #00d4ff; }
        .controls {
            margin-top: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        button {
            background: #00d4ff;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        button:hover { background: #00a8cc; }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }
        .hint { color: #666; font-size: 0.8rem; }
        .status { font-size: 0.9rem; margin-left: auto; }
        .status.processing { color: #ffcc00; }
        .status.success { color: #00ff88; }
        .status.error { color: #ff4444; }
        .slide-container {
            background: #fff;
            border-radius: 4px;
            overflow: hidden;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .slide-container svg { width: 100%; height: 100%; }
        .slide-container .placeholder { color: #888; }
        .slide-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }
        .slide-nav button { padding: 8px 16px; }
        .slide-info { color: #888; font-size: 0.9rem; min-width: 50px; text-align: center; }
        .api-bar {
            margin-bottom: 20px;
            padding: 12px 15px;
            background: #0f0f23;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
        }
        .api-bar select {
            background: #16213e;
            color: #eee;
            border: 1px solid #333;
            padding: 6px 10px;
            border-radius: 4px;
        }
        .api-bar code { color: #00ff88; }
        .api-bar .spacer { flex: 1; }
        .kbd {
            background: #333;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DeckFS Demo</h1>
        <p class="subtitle">Convert decksh markup to SVG slides</p>

        <div class="api-bar">
            <strong>API:</strong>
            <select id="apiSelect">
                <option value="https://deckfs.gedw99.workers.dev">Production</option>
                <option value="http://localhost:8787">Wrangler :8787</option>
                <option value="http://localhost:8080">Wazero :8080</option>
            </select>
            <code id="apiUrl">https://deckfs.gedw99.workers.dev/process</code>
            <span class="spacer"></span>
            <span class="hint">Arrow keys navigate slides</span>
        </div>

        <div class="layout">
            <div class="panel">
                <div class="panel-header">
                    <h2>Decksh Source</h2>
                    <div class="toolbar">
                        <input type="text" id="search" placeholder="Search..." style="padding: 6px 10px; background: #0f0f23; color: #eee; border: 1px solid #333; border-radius: 4px; font-size: 0.85rem; width: 120px;">
                        <select id="examples" style="min-width: 180px;">
                            <option value="">Loading...</option>
                        </select>
                        <select id="filter" style="min-width: 120px;">
                            <option value="all">All Files</option>
                            <option value="renderable" selected>Renderable</option>
                        </select>
                    </div>
                </div>
                <textarea id="source" placeholder="Enter decksh markup...">deck
    slide "white" "black"
        ctext "Hello DeckFS" 50 50 5
        text "Convert decksh to SVG" 50 60 2.5 "sans" "gray"
    eslide

    slide "navy" "white"
        ctext "Slide 2" 50 45 6
        rect 50 65 30 10 "dodgerblue"
        circle 30 65 5 "red"
        circle 70 65 5 "green"
    eslide

    slide "white" "black"
        ctext "Features" 50 20 4
        list 20 35 2.5 "sans" "black" 100
            li "Fast WASM-based rendering"
            li "Multiple output formats"
            li "Cloud-native architecture"
            li "Queue-based processing"
        elist
    eslide
edeck</textarea>
                <div class="controls">
                    <button id="process">Process</button>
                    <span class="hint"><span class="kbd">Ctrl</span>+<span class="kbd">Enter</span></span>
                    <span id="status" class="status"></span>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h2>Preview</h2>
                    <div class="toolbar">
                        <span class="hint"><span class="kbd">&larr;</span> <span class="kbd">&rarr;</span> navigate</span>
                    </div>
                </div>
                <div class="slide-container" id="preview">
                    <span class="placeholder">Press Process or <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span></span>
                </div>
                <div class="slide-nav">
                    <button id="prev" disabled>&larr; Prev</button>
                    <span class="slide-info" id="slideInfo">-</span>
                    <button id="next" disabled>Next &rarr;</button>
                    <button id="shareDeck" disabled style="margin-left: auto;" title="Open deck in new tab">ðŸ“¤ Share</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let API_BASE = 'https://deckfs.gedw99.workers.dev';
        let API_URL = API_BASE + '/process';

        // Examples loaded dynamically from .src/deckviz
        let examplesList = [];
        let currentSourcePath = ''; // Track current example path for import resolution

        let slides = [];
        let currentSlide = 0;

        const sourceEl = document.getElementById('source');
        const processBtn = document.getElementById('process');
        const statusEl = document.getElementById('status');
        const previewEl = document.getElementById('preview');
        const prevBtn = document.getElementById('prev');
        const nextBtn = document.getElementById('next');
        const slideInfoEl = document.getElementById('slideInfo');
        const shareDeckBtn = document.getElementById('shareDeck');
        const examplesEl = document.getElementById('examples');
        const apiSelectEl = document.getElementById('apiSelect');

        function updateApiUrl() {
            API_BASE = apiSelectEl.value;
            API_URL = API_BASE + '/process';
            document.getElementById('apiUrl').textContent = API_URL;
        }

        // Auto-detect localhost
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            apiSelectEl.value = 'http://localhost:8080';
            updateApiUrl();
        }

        apiSelectEl.addEventListener('change', () => {
            updateApiUrl();
            loadExamplesList();
        });

        function setStatus(text, type = '') {
            statusEl.textContent = text;
            statusEl.className = 'status ' + type;
        }

        function updateNav() {
            prevBtn.disabled = currentSlide <= 0;
            nextBtn.disabled = currentSlide >= slides.length - 1;
            slideInfoEl.textContent = slides.length > 0 ? `${currentSlide + 1} / ${slides.length}` : '-';
            // Enable share button only when viewing a deck from examples
            shareDeckBtn.disabled = !currentSourcePath || slides.length === 0;
        }

        function showSlide(index) {
            if (index >= 0 && index < slides.length) {
                currentSlide = index;
                previewEl.innerHTML = slides[index];
                updateNav();

                // Intercept clicks on SVG links to navigate within demo instead of away from it
                const svg = previewEl.querySelector('svg');
                if (svg) {
                    svg.addEventListener('click', (e) => {
                        // Find if click was on or inside an <a> element
                        let target = e.target;
                        while (target && target !== svg) {
                            // SVG uses lowercase tag names
                            if (target.tagName.toLowerCase() === 'a') {
                                // Prevent navigation
                                e.preventDefault();
                                e.stopPropagation();

                                // Check if this is a slide navigation link
                                const href = target.getAttribute('xlink:href') || target.getAttribute('href');
                                if (href) {
                                    // Parse slide number from /deck/path/slide/N.svg
                                    const match = href.match(/\/slide\/(\d+)\.svg$/);
                                    if (match) {
                                        const slideNum = parseInt(match[1], 10);
                                        // Navigate to that slide (convert from 1-indexed to 0-indexed)
                                        if (slideNum >= 1 && slideNum <= slides.length) {
                                            showSlide(slideNum - 1);
                                        }
                                    }
                                }
                                return false;
                            }
                            target = target.parentElement;
                        }
                    });
                }
            }
        }

        async function process() {
            const source = sourceEl.value.trim();
            if (!source) {
                setStatus('Enter decksh source', 'error');
                return;
            }

            processBtn.disabled = true;
            setStatus('Processing...', 'processing');

            try {
                // Add source path for import resolution if we have one
                let url = API_URL;
                if (currentSourcePath) {
                    url += '?source=' + encodeURIComponent(currentSourcePath);
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: source
                });

                const data = await response.json();

                if (data.success) {
                    slides = data.slides;
                    currentSlide = 0;
                    showSlide(0);
                    setStatus(`${data.slideCount} slide${data.slideCount > 1 ? 's' : ''}`, 'success');
                } else {
                    setStatus(data.error || 'Failed', 'error');
                    previewEl.innerHTML = '<span class="placeholder">Error rendering</span>';
                }
            } catch (err) {
                setStatus('Network error', 'error');
            } finally {
                processBtn.disabled = false;
            }
        }

        processBtn.addEventListener('click', process);
        prevBtn.addEventListener('click', () => showSlide(currentSlide - 1));
        nextBtn.addEventListener('click', () => showSlide(currentSlide + 1));

        shareDeckBtn.addEventListener('click', () => {
            if (currentSourcePath) {
                const deckUrl = `${API_BASE}/deck/${currentSourcePath}/slide/${currentSlide + 1}.svg`;
                window.open(deckUrl, '_blank');
            }
        });

        // Clear source path when user manually edits
        sourceEl.addEventListener('input', () => {
            currentSourcePath = '';
            updateNav(); // Update share button state
        });

        // Load examples list from API
        async function loadExamplesList() {
            try {
                const filterMode = document.getElementById('filter').value;
                const url = filterMode === 'renderable' 
                    ? API_BASE + '/examples?renderable=true'
                    : API_BASE + '/examples';
                
                const response = await fetch(url);
                const data = await response.json();
                examplesList = data.examples;

                // Group by directory
                const groups = {};
                examplesList.forEach(ex => {
                    const parts = ex.name.split('/');
                    const dir = parts.length > 1 ? parts[0] : 'root';
                    if (!groups[dir]) groups[dir] = [];
                    groups[dir].push(ex);
                });

                // Populate dropdown with optgroups
                const modeLabel = filterMode === 'renderable' ? ' Renderable' : ' All';
                examplesEl.innerHTML = `<option value="">Examples (${examplesList.length}${modeLabel})</option>`;
                
                Object.keys(groups).sort().forEach(dir => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = dir.charAt(0).toUpperCase() + dir.slice(1);
                    groups[dir].forEach(ex => {
                        const opt = document.createElement('option');
                        opt.value = ex.path;
                        const fileName = ex.name.split('/').pop();
                        opt.textContent = fileName;
                        if (ex.renderable === false) {
                            opt.textContent += ' [lib]';
                            opt.style.color = '#888';
                            opt.style.fontStyle = 'italic';
                        }
                        optgroup.appendChild(opt);
                    });
                    examplesEl.appendChild(optgroup);
                });
            } catch (err) {
                console.error('Failed to load examples:', err);
                examplesEl.innerHTML = '<option value="">Examples (offline)</option>';
            }
        }

        // Auto-process on example selection
        examplesEl.addEventListener('change', async (e) => {
            if (e.target.value) {
                try {
                    const response = await fetch(API_BASE + '/examples/' + e.target.value);
                    const content = await response.text();
                    sourceEl.value = content;
                    currentSourcePath = e.target.value; // Track source path for imports
                    examplesEl.value = '';
                    process();
                } catch (err) {
                    setStatus('Failed to load example', 'error');
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') showSlide(currentSlide - 1);
            if (e.key === 'ArrowRight') showSlide(currentSlide + 1);
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                process();
            }
        });

        updateNav();
        // Search functionality
        document.getElementById('search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const optgroups = document.getElementById('examples').querySelectorAll('optgroup');
            
            optgroups.forEach(group => {
                let hasVisibleOptions = false;
                Array.from(group.children).forEach(opt => {
                    const text = opt.textContent.toLowerCase();
                    const matches = searchTerm === '' || text.includes(searchTerm);
                    opt.style.display = matches ? '' : 'none';
                    if (matches && opt.value) hasVisibleOptions = true;
                });
                group.style.display = hasVisibleOptions ? '' : 'none';
            });
        });

        // Filter change handler
        document.getElementById('filter').addEventListener('change', loadExamplesList);

        loadExamplesList();
    </script>
</body>
</html>
